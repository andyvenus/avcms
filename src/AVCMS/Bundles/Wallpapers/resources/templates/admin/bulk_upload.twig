{% extends '@admin/editor.twig' %}

{% block title %}
    {% trans %}Bulk Upload Files{% endtrans %}
{% endblock %}

{% block editor_title %}
    {{ block('title') }}
{% endblock %}

{% block editor_content %}
    <span class="always-refresh"></span>

    <div class="bulk-upload">
        {{ form_start(form) }}

        {{ form_messages(form) }}

        {{ form_rows(form) }}

        {{ form_end(form) }}

        <div class="form-group">
            <button class="btn btn-primary start-upload-btn" style="display: none;">{% trans %}Start Upload{% endtrans %}</button>
        </div>
    </div>

    <div class="form-group new-upload" style="display:none;overflow: hidden;">
        <button class="btn btn-warning btn-large new-upload-button">{% trans %}New Upload{% endtrans %}</button>
    </div>

    <div class="selected-files-area"></div>

    <script type="text/javascript">
        avcms = avcms || {};

        $(document).ready(function() {
            $('.new-upload-button').click(avcms.wallpaper_bulk.newUpload);
        });

        avcms.wallpaper_bulk = {
            newUpload: function() {
                avcms.nav.refreshSection('.ajax-editor-inner', 'editor');
            }
        };

        $('.bulk-file-upload').fileupload({
            url: avcms.config.site_url+'admin/wallpapers/upload',
            dataType: 'json',
            add: function (e, data) {
                var file = data.files[0];

                $('.selected-files-area').append('<div class="well well-sm clearfix" data-image-name="'+file.name+'">' +
                    '<div class="col-md-6"> <img class="new-image" src="" width="90"/> '+file.name+'</div>' +
                    '<div class="col-md-6 text-right image-upload-progress"></div>' +
                '</div>');

                var file_extension = file.name.split('.').pop();
                var valid_extensions = ['png', 'gif', 'jpg', 'jpeg', 'bmp'];

                if (valid_extensions.indexOf(file_extension) !== -1) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('.new-image[src=""]').first().attr('src', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
                else {
                    $('.new-image[src=""]').first().remove();
                }

                data.context = $('.start-upload-btn').show().click(function () {
                    data.submit();
                });
            },
            start: function (e) {
                $('.bulk-upload').slideUp();
            },
            stop: function (e) {
                $('.new-upload').slideDown();
            },
            done: function (e, data) {
                var name = data.files[0].name;
                var progresser = $('[data-image-name="'+name+'"]').find('.image-upload-progress');
                if (data.result.success === true) {
                    progresser.html('<div class="label label-success">100%</div>');
                }
                else {
                    progresser.html('<div class="label label-danger">'+data.result.error+'</div>');
                }
            },
            progress: function (e, data) {
                var name = data.files[0].name;
                var progress = parseInt(data.loaded / data.total * 100, 10);

                var progresser = $('[data-image-name="'+name+'"]').find('.image-upload-progress');

                progresser.html('<div class="label label-info">'+progress+'%</div>');
            },
            fail: function() {
                alert('f');
            }
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');

    </script>
{% endblock %}
