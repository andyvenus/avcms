/*
 * jQuery UI Nested Sortable
 * v 2.0 / 29 oct 2012
 * http://mjsarfatti.com/sandbox/nestedSortable
 *
 * Depends on:
 *	 jquery.ui.sortable.js 1.10+
 *
 * Copyright (c) 2010-2013 Manuele J Sarfatti
 * Licensed under the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */

(function(e){function t(e,t,n){return e>t&&e<t+n}e.widget("mjs.nestedSortable",e.extend({},e.ui.sortable.prototype,{options:{disableParentChange:false,doNotClear:false,expandOnHover:700,isAllowed:function(e,t,n){return true},isTree:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){this.element.data("ui-sortable",this.element.data("mjs-nestedSortable"));if(!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check that the listType option is set to your actual list type");if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance="intersect"}e.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){var t=this;e(this.items).each(function(){var e=this.item;if(e.children(t.options.listType).length){e.addClass(t.options.branchClass);if(!e.hasClass(t.options.collapsedClass)&&!e.hasClass(t.options.expandedClass)){if(t.options.startCollapsed)e.addClass(t.options.collapsedClass);else e.addClass(t.options.expandedClass)}}else{e.addClass(t.options.leafClass)}})}},_destroy:function(){this.element.removeData("mjs-nestedSortable").removeData("ui-sortable");return e.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(t){var n,r,i,s,o=this.options,u=false;this.position=this._generatePosition(t);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<o.scrollSensitivity){this.scrollParent[0].scrollTop=u=this.scrollParent[0].scrollTop+o.scrollSpeed}else if(t.pageY-this.overflowOffset.top<o.scrollSensitivity){this.scrollParent[0].scrollTop=u=this.scrollParent[0].scrollTop-o.scrollSpeed}if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<o.scrollSensitivity){this.scrollParent[0].scrollLeft=u=this.scrollParent[0].scrollLeft+o.scrollSpeed}else if(t.pageX-this.overflowOffset.left<o.scrollSensitivity){this.scrollParent[0].scrollLeft=u=this.scrollParent[0].scrollLeft-o.scrollSpeed}}else{if(t.pageY-e(document).scrollTop()<o.scrollSensitivity){u=e(document).scrollTop(e(document).scrollTop()-o.scrollSpeed)}else if(e(window).height()-(t.pageY-e(document).scrollTop())<o.scrollSensitivity){u=e(document).scrollTop(e(document).scrollTop()+o.scrollSpeed)}if(t.pageX-e(document).scrollLeft()<o.scrollSensitivity){u=e(document).scrollLeft(e(document).scrollLeft()-o.scrollSpeed)}else if(e(window).width()-(t.pageX-e(document).scrollLeft())<o.scrollSensitivity){u=e(document).scrollLeft(e(document).scrollLeft()+o.scrollSpeed)}}if(u!==false&&e.ui.ddmanager&&!o.dropBehaviour)e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute");var a=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;var f=this.placeholder[0].parentNode.parentNode&&e(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?e(this.placeholder[0].parentNode.parentNode):null,l=this._getLevel(this.placeholder),c=this._getChildLevels(this.helper);var h=document.createElement(o.listType);for(n=this.items.length-1;n>=0;n--){r=this.items[n];i=r.item[0];s=this._intersectsWithPointer(r);if(!s){continue}if(r.instance!==this.currentContainer){continue}if(i.className.indexOf(o.disabledClass)!==-1){if(s===2){var p=this.items[n+1];if(p&&p.item[0].className.indexOf(o.disabledClass)!==-1){continue}}else if(s===1){var d=this.items[n-1];if(d&&d.item[0].className.indexOf(o.disabledClass)!==-1){continue}}}if(i!==this.currentItem[0]&&this.placeholder[s===1?"next":"prev"]()[0]!==i&&!e.contains(this.placeholder[0],i)&&(this.options.type==="semi-dynamic"?!e.contains(this.element[0],i):true)){if(!this.mouseentered){e(i).mouseenter();this.mouseentered=true}if(o.isTree&&e(i).hasClass(o.collapsedClass)&&o.expandOnHover){if(!this.hovering){e(i).addClass(o.hoveringClass);var v=this;this.hovering=window.setTimeout(function(){e(i).removeClass(o.collapsedClass).addClass(o.expandedClass);v.refreshPositions();v._trigger("expand",t,v._uiHash())},o.expandOnHover)}}this.direction=s==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(r)){e(i).mouseleave();this.mouseentered=false;e(i).removeClass(o.hoveringClass);this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;if(o.protectRoot&&!(this.currentItem[0].parentNode==this.element[0]&&i.parentNode!=this.element[0])){if(this.currentItem[0].parentNode!=this.element[0]&&i.parentNode==this.element[0]){if(!e(i).children(o.listType).length){i.appendChild(h);o.isTree&&e(i).removeClass(o.leafClass).addClass(o.branchClass+" "+o.expandedClass)}var m=this.direction==="down"?e(i).prev().children(o.listType):e(i).children(o.listType);if(m[0]!==undefined){this._rearrange(t,null,m)}}else{this._rearrange(t,r)}}else if(!o.protectRoot){this._rearrange(t,r)}}else{break}this._clearEmpty(i);this._trigger("change",t,this._uiHash());break}}var g=this.placeholder[0].previousSibling?e(this.placeholder[0].previousSibling):null;if(g!=null){while(g[0].nodeName.toLowerCase()!="li"||g[0].className.indexOf(o.disabledClass)!==-1||g[0]==this.currentItem[0]||g[0]==this.helper[0]){if(g[0].previousSibling){g=e(g[0].previousSibling)}else{g=null;break}}}var y=this.placeholder[0].nextSibling?e(this.placeholder[0].nextSibling):null;if(y!=null){while(y[0].nodeName.toLowerCase()!="li"||y[0].className.indexOf(o.disabledClass)!==-1||y[0]==this.currentItem[0]||y[0]==this.helper[0]){if(y[0].nextSibling){y=e(y[0].nextSibling)}else{y=null;break}}}this.beyondMaxLevels=0;if(f!=null&&y==null&&!(o.protectRoot&&f[0].parentNode==this.element[0])&&(o.rtl&&this.positionAbs.left+this.helper.outerWidth()>f.offset().left+f.outerWidth()||!o.rtl&&this.positionAbs.left<f.offset().left)){f.after(this.placeholder[0]);if(o.isTree&&f.children(o.listItem).children("li:visible:not(.ui-sortable-helper)").length<1){f.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}this._clearEmpty(f[0]);this._trigger("change",t,this._uiHash())}else if(g!=null&&!g.hasClass(o.disableNestingClass)&&(g.children(o.listType).length&&g.children(o.listType).is(":visible")||!g.children(o.listType).length)&&!(o.protectRoot&&this.currentItem[0].parentNode==this.element[0])&&(o.rtl&&this.positionAbs.left+this.helper.outerWidth()<g.offset().left+g.outerWidth()-o.tabSize||!o.rtl&&this.positionAbs.left>g.offset().left+o.tabSize)){this._isAllowed(g,l,l+c+1);if(!g.children(o.listType).length){g[0].appendChild(h);o.isTree&&g.removeClass(o.leafClass).addClass(o.branchClass+" "+o.expandedClass)}if(a&&a<=g.offset().top){g.children(o.listType).prepend(this.placeholder)}else{g.children(o.listType)[0].appendChild(this.placeholder[0])}this._trigger("change",t,this._uiHash())}else{this._isAllowed(f,l,l+c)}this._contactContainers(t);if(e.ui.ddmanager){e.ui.ddmanager.drag(this,t)}this._trigger("sort",t,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(t,n){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){e(this.domPosition.prev).after(this.placeholder)}else{e(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",t,this._uiHash())}e("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;e.ui.sortable.prototype._mouseStop.apply(this,arguments);var r=e(this.domPosition.parent).parent().attr("id");var i=this.domPosition.prev?e(this.domPosition.prev).next().index():0;if(!(r==this._uiHash().item.parent().parent().attr("id")&&i==this._uiHash().item.index())){this._trigger("relocate",t,this._uiHash())}},_intersectsWithSides:function(e){var n=this.options.isTree?.8:.5;var r=t(this.positionAbs.top+this.offset.click.top,e.top+e.height*n,e.height),i=t(this.positionAbs.top+this.offset.click.top,e.top-e.height*n,e.height),s=t(this.positionAbs.left+this.offset.click.left,e.left+e.width/2,e.width),o=this._getDragVerticalDirection(),u=this._getDragHorizontalDirection();if(this.floating&&u){return u=="right"&&s||u=="left"&&!s}else{return o&&(o=="down"&&r||o=="up"&&i)}},_contactContainers:function(t){if(this.options.protectRoot&&this.currentItem[0].parentNode==this.element[0]){return}e.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(t,n){e.ui.sortable.prototype._clear.apply(this,arguments);for(var r=this.items.length-1;r>=0;r--){var i=this.items[r].item[0];this._clearEmpty(i)}},serialize:function(t){var n=e.extend({},this.options,t),r=this._getItemsAsjQuery(n&&n.connected),i=[];e(r).each(function(){var t=(e(n.item||this).attr(n.attribute||"id")||"").match(n.expression||/(.+)[-=_](.+)/),r=(e(n.item||this).parent(n.listType).parent(n.items).attr(n.attribute||"id")||"").match(n.expression||/(.+)[-=_](.+)/);if(t){i.push((n.key||t[1])+"["+(n.key&&n.expression?t[1]:t[2])+"]"+"="+(r?n.key&&n.expression?r[1]:r[2]:n.rootID))}});if(!i.length&&n.key){i.push(n.key+"=")}return i.join("&")},toHierarchy:function(t){function s(t){var r=(e(t).attr(n.attribute||"id")||"").match(n.expression||/(.+)[-=_](.+)/);if(r){var i={id:r[2]};if(e(t).children(n.listType).children(n.items).length>0){i.children=[];e(t).children(n.listType).children(n.items).each(function(){var e=s(this);i.children.push(e)})}return i}}var n=e.extend({},this.options,t),r=n.startDepthCount||0,i=[];e(this.element).children(n.items).each(function(){var e=s(this);i.push(e)});return i},toArray:function(t){function o(t,s,u){var a=u+1,f,l;if(e(t).children(n.listType).children(n.items).length>0){s++;e(t).children(n.listType).children(n.items).each(function(){a=o(e(this),s,a)});s--}f=e(t).attr(n.attribute||"id").match(n.expression||/(.+)[-=_](.+)/);if(s===r+1){l=n.rootID}else{var c=e(t).parent(n.listType).parent(n.items).attr(n.attribute||"id").match(n.expression||/(.+)[-=_](.+)/);l=c[2]}if(f){i.push({item_id:f[2],parent_id:l,depth:s,left:u,right:a})}u=a+1;return u}var n=e.extend({},this.options,t),r=n.startDepthCount||0,i=[],s=1;if(!n.excludeRoot){i.push({item_id:n.rootID,parent_id:null,depth:r,left:s,right:(e(n.items,this.element).length+1)*2});s++}e(this.element).children(n.items).each(function(){s=o(this,r+1,s)});i=i.sort(function(e,t){return e.left-t.left});return i},_clearEmpty:function(t){var n=this.options;var r=e(t).children(n.listType);if(r.length&&!r.children().length&&!n.doNotClear){n.isTree&&e(t).removeClass(n.branchClass+" "+n.expandedClass).addClass(n.leafClass);r.remove()}else if(n.isTree&&r.length&&r.children().length&&r.is(":visible")){e(t).removeClass(n.leafClass).addClass(n.branchClass+" "+n.expandedClass)}else if(n.isTree&&r.length&&r.children().length&&!r.is(":visible")){e(t).removeClass(n.leafClass).addClass(n.branchClass+" "+n.collapsedClass)}},_getLevel:function(e){var t=1;if(this.options.listType){var n=e.closest(this.options.listType);while(n&&n.length>0&&!n.is(".ui-sortable")){t++;n=n.parent().closest(this.options.listType)}}return t},_getChildLevels:function(t,n){var r=this,i=this.options,s=0;n=n||0;e(t).children(i.listType).children(i.items).each(function(e,t){s=Math.max(r._getChildLevels(t,n+1),s)});return n?s+1:s},_isAllowed:function(e,t,n){var r=this.options,i=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");var s=this.currentItem.parent().parent();var o=r.disableParentChange&&(e!==null&&!s.is(e)||e===null&&s.is("li"));if(o||!r.isAllowed(this.placeholder,e,this.currentItem)){this.placeholder.addClass(r.errorClass);if(i<n&&i!=0){this.beyondMaxLevels=n-i}else{this.beyondMaxLevels=1}}else{if(i<n&&i!=0){this.placeholder.addClass(r.errorClass);this.beyondMaxLevels=n-i}else{this.placeholder.removeClass(r.errorClass);this.beyondMaxLevels=0}}}}));e.mjs.nestedSortable.prototype.options=e.extend({},e.ui.sortable.prototype.options,e.mjs.nestedSortable.prototype.options)})(jQuery)